info:
  title: Grid Services Backend API
  version: 0.3.0
  description: |
    API for the Smart Grid Control Center dashboard.
    Endpoints aggregate persisted VEN telemetry and expose fixture-backed
    administration flows used by the current UI.
servers:
  - url: /api
paths:
  /stats/network:
    get:
      summary: Get current network metrics
      tags: [Stats]
      responses:
        '200':
          description: Current network metrics aggregated from the latest VEN telemetry
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NetworkStats'
  /stats/loads:
    get:
      summary: Get aggregated load statistics by type
      tags: [Stats]
      responses:
        '200':
          description: Aggregated capability and usage by load type
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LoadTypeStats'
  /stats/network/history:
    get:
      summary: Query historical network metrics
      tags: [Stats, History]
      parameters:
        - in: query
          name: start
          required: false
          schema:
            type: string
            format: date-time
          description: Start of the interval (defaults to earliest stored sample)
        - in: query
          name: end
          required: false
          schema:
            type: string
            format: date-time
          description: End of the interval (defaults to latest stored sample)
        - in: query
          name: granularity
          required: false
          schema:
            type: string
            description: Aggregation step (e.g., 5m, 1h)
            default: 5m
      responses:
        '200':
          description: Time series of network metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HistoryResponse'
  /vens:
    get:
      summary: List all VENs (fixture-backed)
      tags: [VENs]
      responses:
        '200':
          description: Array of VENs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Ven'
    post:
      summary: Register a new VEN (fixture-backed)
      tags: [VENs]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VenCreate'
      responses:
        '201':
          description: VEN created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ven'
  /vens/{venId}:
    parameters:
      - in: path
        name: venId
        required: true
        schema:
          type: string
    get:
      summary: Get details for a specific VEN (fixture-backed)
      tags: [VENs]
      responses:
        '200':
          description: VEN details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ven'
    patch:
      summary: Update configuration for a VEN (fixture-backed)
      tags: [VENs]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VenUpdate'
      responses:
        '200':
          description: Updated VEN
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ven'
    delete:
      summary: Remove a VEN (fixture-backed)
      tags: [VENs]
      responses:
        '204':
          description: VEN deleted
  /vens/{venId}/loads:
    parameters:
      - in: path
        name: venId
        required: true
        schema:
          type: string
    get:
      summary: List loads managed by a VEN
      tags: [Loads]
      responses:
        '200':
          description: Array of loads with the latest telemetry sample
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Load'
  /vens/{venId}/loads/{loadId}:
    parameters:
      - in: path
        name: venId
        required: true
        schema:
          type: string
      - in: path
        name: loadId
        required: true
        schema:
          type: string
    get:
      summary: Get load details
      tags: [Loads]
      responses:
        '200':
          description: Load information from the latest telemetry sample
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Load'
    patch:
      summary: Update load configuration (fixture-backed)
      tags: [Loads]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoadUpdate'
      responses:
        '200':
          description: Updated load (fixture-backed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Load'
  /vens/{venId}/loads/{loadId}/commands/shed:
    post:
      summary: Issue a load shed command for a specific load (fixture-backed)
      tags: [Loads]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShedCommand'
      responses:
        '202':
          description: Shed command accepted
  /vens/{venId}/history:
    parameters:
      - in: path
        name: venId
        required: true
        schema:
          type: string
    get:
      summary: Get historical metrics for a VEN
      tags: [History]
      parameters:
        - in: query
          name: start
          required: false
          schema:
            type: string
            format: date-time
        - in: query
          name: end
          required: false
          schema:
            type: string
            format: date-time
        - in: query
          name: granularity
          required: false
          schema:
            type: string
            description: Aggregation step (e.g., 5m, 1h)
            default: 5m
      responses:
        '200':
          description: Time series of VEN metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HistoryResponse'
  /vens/{venId}/loads/{loadId}/history:
    parameters:
      - in: path
        name: venId
        required: true
        schema:
          type: string
      - in: path
        name: loadId
        required: true
        schema:
          type: string
    get:
      summary: Get historical metrics for a specific load
      tags: [History]
      parameters:
        - in: query
          name: start
          required: false
          schema:
            type: string
            format: date-time
        - in: query
          name: end
          required: false
          schema:
            type: string
            format: date-time
        - in: query
          name: granularity
          required: false
          schema:
            type: string
            description: Aggregation step (e.g., 5m, 1h)
            default: 5m
      responses:
        '200':
          description: Time series of load metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HistoryResponse'
  /events:
    get:
      summary: List ADR events (fixture-backed)
      tags: [Events]
      responses:
        '200':
          description: Array of events
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Event'
    post:
      summary: Start a new ADR event (fixture-backed)
      tags: [Events]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [startTime, endTime, requestedReductionKw]
              properties:
                startTime:
                  type: string
                  format: date-time
                endTime:
                  type: string
                  format: date-time
                requestedReductionKw:
                  type: number
      responses:
        '201':
          description: Event created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
  /events/{eventId}:
    parameters:
      - in: path
        name: eventId
        required: true
        schema:
          type: string
    get:
      summary: Get ADR event details (fixture-backed)
      tags: [Events]
      responses:
        '200':
          description: Event details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
    delete:
      summary: Cancel an event (fixture-backed)
      tags: [Events]
      responses:
        '204':
          description: Event cancelled
  /events/{eventId}/stop:
    post:
      summary: Stop an active event (fixture-backed)
      tags: [Events]
      responses:
        '202':
          description: Event stop command accepted
  /events/current:
    get:
      summary: Get the currently active ADR event if any (fixture-backed)
      tags: [Events]
      responses:
        '200':
          description: Active event (or null when none)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/Event'
                  - type: 'null'
  /events/history:
    get:
      summary: Query historical ADR events (fixture-backed)
      tags: [Events, History]
      parameters:
        - in: query
          name: start
          required: false
          schema:
            type: string
            format: date-time
        - in: query
          name: end
          required: false
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Events within the interval
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Event'
components:
  schemas:
    NetworkStats:
      type: object
      properties:
        venCount:
          type: integer
          description: Number of registered VENs
        controllablePowerKw:
          type: number
          description: Total kW available for control
        potentialLoadReductionKw:
          type: number
          description: Potential kW reduction if fully shed
        householdUsageKw:
          type: number
          description: Current aggregated usage in kW
        onlineVens:
          type: integer
          nullable: true
          description: Count of VENs reporting an "online" status
        currentLoadReductionKw:
          type: number
          nullable: true
          description: Currently delivered shed amount
        networkEfficiency:
          type: number
          nullable: true
        averageHousePower:
          type: number
          nullable: true
          description: Average per-VEN usage when telemetry is available
        totalHousePowerToday:
          type: number
          nullable: true
      required: [venCount, controllablePowerKw, potentialLoadReductionKw, householdUsageKw]
    LoadTypeStats:
      type: object
      properties:
        type:
          type: string
          description: Load category (e.g., ev, solar, hvac)
        totalCapacityKw:
          type: number
          description: Total capacity in kW
        totalShedCapabilityKw:
          type: number
          description: Total shed capability in kW
        currentUsageKw:
          type: number
          description: Current aggregated usage in kW
      required: [type, totalCapacityKw, totalShedCapabilityKw, currentUsageKw]
    Location:
      type: object
      properties:
        lat:
          type: number
        lon:
          type: number
      required: [lat, lon]
    VenMetrics:
      type: object
      properties:
        currentPowerKw:
          type: number
        shedAvailabilityKw:
          type: number
        activeEventId:
          type: string
          nullable: true
        shedLoadIds:
          type: array
          items:
            type: string
      required: [currentPowerKw, shedAvailabilityKw, shedLoadIds]
    Ven:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        status:
          type: string
        location:
          $ref: '#/components/schemas/Location'
        loads:
          type: array
          items:
            $ref: '#/components/schemas/Load'
        metrics:
          $ref: '#/components/schemas/VenMetrics'
      required: [id, name, status, location, loads, metrics]
    VenCreate:
      type: object
      properties:
        name:
          type: string
        location:
          $ref: '#/components/schemas/Location'
      required: [name, location]
    VenUpdate:
      type: object
      description: Partial VEN update (fixture-backed)
      properties:
        name:
          type: string
        status:
          type: string
        location:
          $ref: '#/components/schemas/Location'
    Load:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
        capacityKw:
          type: number
          nullable: true
          description: Maximum power in kW (if reported)
        shedCapabilityKw:
          type: number
          description: Shed capability in kW
        currentPowerKw:
          type: number
          description: Current power usage in kW
        name:
          type: string
          nullable: true
      required: [id, type, shedCapabilityKw, currentPowerKw]
    LoadUpdate:
      type: object
      description: Partial load update (fixture-backed)
      properties:
        name:
          type: string
        type:
          type: string
        capacityKw:
          type: number
        shedCapabilityKw:
          type: number
    ShedCommand:
      type: object
      properties:
        amountKw:
          type: number
          description: Kilowatts to shed
      required: [amountKw]
    Event:
      type: object
      properties:
        id:
          type: string
        status:
          type: string
          enum: [scheduled, active, completed, cancelled]
        startTime:
          type: string
          format: date-time
        endTime:
          type: string
          format: date-time
        requestedReductionKw:
          type: number
        actualReductionKw:
          type: number
          default: 0
      required: [id, status, startTime, endTime, requestedReductionKw]
    TimeseriesPoint:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        usedPowerKw:
          type: number
        shedPowerKw:
          type: number
        eventId:
          type: string
          nullable: true
        requestedReductionKw:
          type: number
          nullable: true
      required: [timestamp, usedPowerKw, shedPowerKw]
    HistoryResponse:
      type: object
      properties:
        points:
          type: array
          items:
            $ref: '#/components/schemas/TimeseriesPoint'
      required: [points]
