<!--
  Enhanced VEN Control UI with Loads Table and Live Gauge
  Incorporates UI improvements from main-diverged branch into clean static architecture
-->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>VOLTTRON VEN Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { --bg:#0b5; --card:#fff; --muted:#666; --accent:#0b5; }
    body { font-family: system-ui, sans-serif; margin: 0; line-height: 1.4; background:#f6f8fa; }
    header { background: var(--bg); color:#fff; padding:12px 16px; position:sticky; top:0; display:flex; align-items:center; gap:12px; }
    header a { color:#fff; margin-left: 12px; text-decoration: underline; }
    main { max-width: 960px; margin: 24px auto; padding: 0 16px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); gap:16px; }
    .card { background: var(--card); border-radius: 10px; padding:16px; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
    .card h2 { margin:0 0 8px; font-size:1.1rem; }
    .field { display:flex; align-items:center; justify-content:space-between; gap:12px; margin:8px 0; }
    .field label { color: var(--muted); }
    .field input[type="number"] { width: 140px; padding: 6px 8px; border:1px solid #ddd; border-radius:8px; }
    .field input[type="checkbox"] { transform: scale(1.2); }
    .actions { display:flex; gap:12px; margin-top:12px; }
    button { background: var(--accent); color:#fff; border:0; border-radius:8px; padding:8px 14px; cursor:pointer; }
    button.secondary { background:#222; }
    .status { margin-top: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; white-space:pre-wrap; }
    /* Live panel styles */
    .panelbox { background:#111; color:#fff; border-radius:12px; padding:16px; box-shadow:inset 0 0 0 2px #000, 0 10px 24px rgba(0,0,0,.25); }
    .led { display:inline-block; width:12px; height:12px; border-radius:50%; box-shadow:0 0 6px rgba(0,0,0,.5); margin-right:6px; vertical-align:middle; }
    .led.ok { background:#2ecc71; }
    .led.bad { background:#e74c3c; }
    .meter { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .big { font-size:2.2rem; font-weight:700; letter-spacing: .5px; }
    .muted { color:#bbb; }
    .kv { display:flex; gap:12px; flex-wrap:wrap; }
    .kv div { background:rgba(255,255,255,.05); padding:8px 10px; border-radius:8px; min-width: 120px; text-align:center; }
    .eventbar { background:#222; color:#eee; border-radius:8px; padding:10px 12px; display:flex; gap:16px; align-items:center; margin-top:10px; }
    .pill { background:#0b5; color:#fff; padding:4px 8px; border-radius:999px; font-size:.8rem; }
    .badge { background:#e67e22; color:#fff; padding:2px 6px; border-radius:6px; font-size:.75rem; margin-left:8px; }
    .build { margin-left:auto; font-size:.8rem; opacity:.9; }
    .gauge { margin-top:10px; width:100%; height:14px; background:#333; border-radius:7px; overflow:hidden; box-shadow: inset 0 0 4px rgba(0,0,0,.5); }
    .bar { height:100%; background: linear-gradient(90deg,#2ecc71,#f1c40f,#e74c3c); width:0%; transition: width .4s ease; }
    table { width:100%; border-collapse: collapse; }
    thead th { text-align:left; font-weight:600; color:#666; padding:8px 10px; border-bottom:1px solid #eee; }
    tbody td { padding:8px 10px; border-bottom:1px solid #f2f2f2; vertical-align: middle; }
    tbody tr:hover { background:#fafafa; }
    td.nowrap { white-space: nowrap; }
    td.actions input[type="number"] { width:100px; }
  </style>
  <script>
    async function getJson(path){
      const r = await fetch(path);
      if(!r.ok) throw new Error('request failed');
      return await r.json();
    }
    function setText(id, value){ const el = document.getElementById(id); if(el) el.textContent = value; }
    
    async function loadCurrent(){
      try{
        const j = await getJson('/config');
        document.getElementById('interval').value = j.report_interval_seconds ?? '';
        document.getElementById('target').value   = j.target_power_kw ?? '';
        document.getElementById('enabled').checked = !!j.enabled;
        // Metering knobs
        document.getElementById('base_min').value = j.meter_base_min_kw ?? 0.5;
        document.getElementById('base_max').value = j.meter_base_max_kw ?? 2.0;
        document.getElementById('jitter').value   = (j.meter_jitter_pct ?? 0.05);
        // Voltage
        document.getElementById('v_enabled').checked = !!j.voltage_enabled;
        document.getElementById('v_nom').value = j.voltage_nominal ?? 120.0;
        document.getElementById('v_jitter').value = (j.voltage_jitter_pct ?? 0.02);
        // Current
        document.getElementById('i_enabled').checked = !!j.current_enabled;
        document.getElementById('pf').value = j.power_factor ?? 1.0;
        setText('status', 'Current: ' + JSON.stringify(j, null, 2));
      }catch(e){}
    }
    
    async function applyChanges(){
      const interval = document.getElementById('interval').value;
      const target   = document.getElementById('target').value;
      const enabled  = document.getElementById('enabled').checked;
      const body = {};
      if(interval) body.report_interval_seconds = Number(interval);
      if(target)   body.target_power_kw = Number(target);
      body.enabled = enabled;
      // Metering knobs
      body.meter_base_min_kw = Number(document.getElementById('base_min').value);
      body.meter_base_max_kw = Number(document.getElementById('base_max').value);
      body.meter_jitter_pct  = Number(document.getElementById('jitter').value);
      // Voltage knobs
      body.voltage_enabled   = document.getElementById('v_enabled').checked;
      body.voltage_nominal   = Number(document.getElementById('v_nom').value);
      body.voltage_jitter_pct= Number(document.getElementById('v_jitter').value);
      // Current knobs
      body.current_enabled   = document.getElementById('i_enabled').checked;
      body.power_factor      = Number(document.getElementById('pf').value);
      const r = await fetch('/config', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      const j = await r.json().catch(()=>({}));
      setText('status', 'Response: ' + JSON.stringify(j));
    }

    // Enhanced load management functions
    function toggleCircuit(id, enabled){
      fetch('/circuits/'+encodeURIComponent(id), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({enabled}) })
        .then(()=>refreshLive()).catch(()=>{});
    }
    function toggleCritical(id, critical){
      fetch('/circuits/'+encodeURIComponent(id), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({critical}) })
        .then(()=>refreshLive()).catch(()=>{});
    }
    function toggleConnected(id, connected){
      fetch('/circuits/'+encodeURIComponent(id), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({connected}) })
        .then(()=>refreshLive()).catch(()=>{});
    }
    function setMode(id, mode){
      fetch('/circuits/'+encodeURIComponent(id), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({mode}) })
        .then(()=>refreshLive()).catch(()=>{});
    }
    function setFixedKw(id, v){
      const fixed_kw = Number(v||0);
      fetch('/circuits/'+encodeURIComponent(id), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({fixed_kw}) })
        .then(()=>refreshLive()).catch(()=>{});
    }

    // Enhanced loads table rendering
    function renderLoads(list){
      const body = document.getElementById('loads-body');
      if(!body) return;
      body.innerHTML = '';
      const shedding = new Set((window.__sheddingIds||[]));
      (list||[]).forEach(c => {
        const tr = document.createElement('tr');
        const shed = shedding.has(c.id) ? '<span class="badge">Shed</span>' : '';
        tr.innerHTML = `
          <td class="nowrap"><strong>${c.name}</strong> <span class="muted">(${c.type||''})</span> ${shed}</td>
          <td><input type="checkbox" ${c.connected!==false? 'checked':''} onchange="toggleConnected('${c.id}', this.checked)"></td>
          <td><input type="checkbox" ${c.enabled? 'checked':''} onchange="toggleCircuit('${c.id}', this.checked)"></td>
          <td>
            <select onchange="setMode('${c.id}', this.value)">
              <option value="dynamic" ${c.mode==='dynamic'?'selected':''}>Dynamic</option>
              <option value="fixed" ${c.mode==='fixed'?'selected':''}>Fixed</option>
            </select>
          </td>
          <td class="actions"><input type="number" step="0.01" min="0" value="${(c.fixedKw??0)}" onblur="setFixedKw('${c.id}', this.value)"></td>
          <td><input type="checkbox" ${c.critical? 'checked':''} onchange="toggleCritical('${c.id}', this.checked)"></td>
          <td class="nowrap">${(c.rated_kw??0).toFixed ? c.rated_kw.toFixed(2) : c.rated_kw} kW</td>
          <td class="nowrap"><strong>${(c.current_kw??0).toFixed ? c.current_kw.toFixed(2) : c.current_kw}</strong> kW</td>
        `;
        body.appendChild(tr);
      });
    }

    // Enhanced live data refresh with fallback logic
    async function refreshLive(){
      try {
        const r = await fetch('/live');
        if(!r.ok) return;
        const j = await r.json();
        const enabled = !!(j.config && j.config.enabled);
        const connected = !!(j.status && j.status.ok);
        document.getElementById('led-enabled').className = 'led ' + (enabled? 'ok':'bad');
        document.getElementById('led-mqtt').className = 'led ' + (connected? 'ok':'bad');
        setText('live-power', j.metering && j.metering.power_kw != null ? j.metering.power_kw.toFixed(2) : '--');
        setText('live-voltage', j.metering && j.metering.voltage_v != null ? j.metering.voltage_v.toFixed(1) : '--');
        setText('live-current', j.metering && j.metering.current_a != null ? j.metering.current_a.toFixed(2) : '--');
        setText('live-target', (j.config && j.config.target_power_kw != null) ? j.config.target_power_kw : '--');
        setText('live-interval', (j.config && j.config.report_interval_seconds) ? j.config.report_interval_seconds : '--');
        const last = (j.events && j.events.event_id) ? `${j.events.event_id}` : '—';
        setText('live-event', last);
        setText('live-last-publish', j.status && j.status.last_publish_at ? j.status.last_publish_at : '—');
        
        if(document.getElementById('live-batt-soc')){
          const soc = j.metering && j.metering.battery_soc != null ? (j.metering.battery_soc*100).toFixed(0) : '--';
          setText('live-batt-soc', soc + '%');
        }
        
        window.__sheddingIds = j.sheddingLoadIds || [];
        
        // Prefer circuits from /live.metering, but fall back to /circuits so
        // the panel always renders even before the first publish.
        const liveCircuits = (j.metering && j.metering.circuits) || [];
        if(Array.isArray(liveCircuits) && liveCircuits.length > 0){
          window.__lastCircuits = liveCircuits;
          renderLoads(liveCircuits);
        } else {
          try {
            const rc = await fetch('/circuits');
            if (rc.ok) {
              const list = await rc.json();
              window.__lastCircuits = list;
              renderLoads(list);
            } else {
              renderLoads([]);
            }
          } catch(e){ renderLoads([]); }
        }
        
        // Update overall draw gauge
        try{
          const list = window.__lastCircuits || [];
          const cap = list.filter(x=>x.connected!==false).reduce((s,c)=> s + (Number(c.rated_kw||0) || 0), 0) || 1;
          const p = (j.metering && j.metering.power_kw!=null) ? Number(j.metering.power_kw) : 0;
          const pct = Math.min(100, Math.max(0, (p/cap)*100));
          const bar = document.getElementById('gauge-bar'); if(bar) bar.style.width = pct.toFixed(0)+'%';
        }catch(e){}
        
        // Update event banners
        const eb = document.getElementById('eventbar');
        if(eb){
          const ae = j.activeEvent;
          if(ae && ae.eventId){
            const mins = Math.floor((ae.remainingS||0)/60), secs = (ae.remainingS||0)%60;
            const req = ae.requestedReductionKw != null ? ae.requestedReductionKw : '--';
            const shed = j.metering && j.metering.shedPowerKw != null ? j.metering.shedPowerKw.toFixed(2) : '--';
            eb.innerHTML = `<span class="pill">Event ${ae.eventId}</span>
                            <span>Time left: <strong>${mins}:${secs.toString().padStart(2,'0')}</strong></span>
                            <span>Requested: <strong>${req} kW</strong></span>
                            <span>Current shed: <strong>${shed} kW</strong></span>`;
          } else {
            eb.innerHTML = '<span class="muted">No active event</span>';
          }
        }
      }catch(e){}
    }

    async function showBuild(){
      try{
        const r = await fetch('/openapi.json');
        const j = await r.json();
        const v = (j && j.info && (j.info["x-build"] || j.info.version)) || '';
        setText('build-id', v);
      }catch(e){ setText('build-id', 'n/a'); }
    }

    function startVen(){ fetch('/start', {method:'POST'}).then(()=>refreshLive()).catch(()=>{}); }
    function stopVen(){ fetch('/stop', {method:'POST'}).then(()=>refreshLive()).catch(()=>{}); }

    window.addEventListener('DOMContentLoaded', ()=>{ showBuild(); loadCurrent(); refreshLive(); setInterval(refreshLive, 2000); });
  </script>
  </head>
  <body>
    <header>
      <strong>VOLTTRON VEN Control</strong>
      <a href="/docs">API Docs</a>
      <a href="/config">Current Config</a>
      <span class="build">Build: <span id="build-id">(loading)</span></span>
    </header>
    <main>
      <div class="grid">
        <section class="card panelbox">
          <div class="meter">
            <div><span class="big" id="live-power">--</span> kW</div>
          </div>
          <div class="kv">
            <div><span class="muted">Voltage</span><br/><strong><span id="live-voltage">--</span> V</strong></div>
            <div><span class="muted">Current</span><br/><strong><span id="live-current">--</span> A</strong></div>
            <div><span class="muted">Target</span><br/><strong><span id="live-target">--</span> kW</strong></div>
            <div><span class="muted">Interval</span><br/><strong><span id="live-interval">--</span> s</strong></div>
            <div><span class="muted">Battery SOC</span><br/><strong><span id="live-batt-soc">--</span></strong></div>
          </div>
          <div class="gauge"><div id="gauge-bar" class="bar"></div></div>
          <div style="margin-top:10px; color:#ccc; display:flex; align-items:center; gap:16px;">
            <div><span id="led-enabled" class="led bad"></span> Enabled</div>
            <div><span id="led-mqtt" class="led bad"></span> MQTT</div>
            <div>Last event: <strong id="live-event">—</strong></div>
            <div>Last publish: <span id="live-last-publish">—</span></div>
            <div class="actions"><button onclick="startVen()">Start</button><button class="secondary" onclick="stopVen()">Stop</button></div>
          </div>
        </section>

        <section class="card">
          <h2>Loads</h2>
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Load</th>
                  <th>Connected</th>
                  <th>Enabled</th>
                  <th>Mode</th>
                  <th>Fixed kW</th>
                  <th>Critical</th>
                  <th>Rated</th>
                  <th>Now</th>
                </tr>
              </thead>
              <tbody id="loads-body"></tbody>
            </table>
          </div>
        </section>

        <section class="card">
          <h2>Event</h2>
          <div id="eventbar" class="eventbar"><span class="muted">No active event</span></div>
        </section>

        <section class="card">
          <h2>General</h2>
          <div class="field"><label>Enabled</label><input id="enabled" type="checkbox"/></div>
          <div class="field"><label>Report interval (s)</label><input id="interval" type="number" min="1" step="1" /></div>
          <div class="field"><label>Target power (kW)</label><input id="target" type="number" step="0.01" /></div>
          <button onclick="applyChanges()">Apply Changes</button>
        </section>

        <section class="card">
          <h2>Power Generation</h2>
          <div class="field"><label>Base min (kW)</label><input id="base_min" type="number" step="0.01" min="0" /></div>
          <div class="field"><label>Base max (kW)</label><input id="base_max" type="number" step="0.01" min="0" /></div>
          <div class="field"><label>Jitter (%) [0..1]</label><input id="jitter" type="number" step="0.005" min="0" max="1" /></div>
        </section>

        <section class="card">
          <h2>Voltage (optional)</h2>
          <div class="field"><label>Include voltage</label><input id="v_enabled" type="checkbox"/></div>
          <div class="field"><label>Nominal (V)</label><input id="v_nom" type="number" step="0.1" min="1" /></div>
          <div class="field"><label>Jitter (%) [0..1]</label><input id="v_jitter" type="number" step="0.005" min="0" max="1" /></div>
        </section>

        <section class="card">
          <h2>Current (optional)</h2>
          <div class="field"><label>Include current</label><input id="i_enabled" type="checkbox"/></div>
          <div class="field"><label>Power factor</label><input id="pf" type="number" step="0.01" min="0.05" max="1" /></div>
        </section>
      </div>
      <div class="status" id="status"></div>
    </main>
  </body>
</html>
