<!--
  Static VEN Control UI
  This file overrides the inline CONFIG_UI_HTML when present in the container.
  You can edit and rebuild to update UI without touching Python.
-->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>VOLTTRON VEN Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { --bg:#0b5; --card:#fff; --muted:#666; --accent:#0b5; }
      body { font-family: system-ui, sans-serif; margin: 0; line-height: 1.4; background:#f6f8fa; }
      header { background: var(--bg); color:#fff; padding:12px 16px; position:sticky; top:0; display:flex; align-items:center; gap:12px; }
      header a { color:#fff; margin-left: 12px; text-decoration: underline; }
      .build { margin-left:auto; font-size:.8rem; opacity:.9; }
      main { padding:16px; max-width: 1024px; margin: 0 auto; }
      .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:16px; }
      .card { background: var(--card); border-radius:12px; padding:16px; box-shadow: 0 2px 8px rgba(0,0,0,.06); }
      .led { width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:6px; vertical-align: middle; background:#bbb; }
      .led.ok { background:#0b5; }
      .led.bad { background:#c33; }
      .muted { color: var(--muted); }
      .controls .field { display:flex; gap:8px; align-items:center; margin:6px 0; }
      .controls label { min-width: 180px; font-size: .9rem; color: var(--muted); }
      .controls input[type="number"], .controls input[type="text"] { width: 120px; }
      .row { display:flex; gap:16px; align-items:center; }
      .pill { background:#0b5; color:#fff; padding:4px 8px; border-radius:999px; font-size:.8rem; }
      .badge { background:#e67e22; color:#fff; padding:2px 6px; border-radius:6px; font-size:.75rem; margin-left:8px; }
      .eventbar { background:#222; color:#eee; border-radius:8px; padding:10px 12px; display:flex; gap:16px; align-items:center; margin-top:10px; }
      button { background: var(--accent); color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; }
    </style>
    <script>
      async function getJson(path){
        const r = await fetch(path);
        if(!r.ok) throw new Error('request failed');
        return await r.json();
      }
      function setText(id, value){ const el = document.getElementById(id); if(el) el.textContent = value; }
      async function loadCurrent(){
        try{
          const j = await getJson('/config');
          (id => { const el = document.getElementById(id); if(el) el.value = j.report_interval_seconds ?? ''; })('interval');
          (id => { const el = document.getElementById(id); if(el) el.value = j.target_power_kw ?? ''; })('target');
          const en = document.getElementById('enabled'); if(en) en.checked = !!j.enabled;
        }catch(e){}
      }
      async function applyChanges(){
        const interval = Number(document.getElementById('interval').value || 0);
        const target   = Number(document.getElementById('target').value || 0);
        const enabled  = document.getElementById('enabled').checked;
        const body = {};
        if(interval) body.report_interval_seconds = interval;
        if(target)   body.target_power_kw = target;
        body.enabled = enabled;
        const r = await fetch('/config', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        const j = await r.json().catch(()=>({}));
        setText('status', 'Response: ' + JSON.stringify(j));
      }
      async function refreshLive(){
        try{
          const j = await getJson('/live');
          const enabled = !!(j.config && j.config.enabled);
          const connected = !!(j.status && j.status.ok);
          document.getElementById('led-enabled').className = 'led ' + (enabled? 'ok':'bad');
          document.getElementById('led-mqtt').className = 'led ' + (connected? 'ok':'bad');
          setText('live-power', j.metering && j.metering.power_kw != null ? j.metering.power_kw.toFixed(2) : '--');
          setText('live-target', (j.config && j.config.target_power_kw != null) ? j.config.target_power_kw : '--');
          setText('live-interval', (j.config && j.config.report_interval_seconds) ? j.config.report_interval_seconds : '--');
          setText('live-event', (j.events && j.events.event_id) ? j.events.event_id : '—');
          setText('live-last-publish', j.status && j.status.last_publish_at ? j.status.last_publish_at : '—');
        }catch(e){}
      }
      async function showBuild(){
        try{
          const r = await fetch('/openapi.json');
          const j = await r.json();
          const v = (j && j.info && (j.info["x-build"] || j.info.version)) || '';
          const el = document.getElementById('build-id'); if(el) el.textContent = v;
        }catch(e){ const el = document.getElementById('build-id'); if(el) el.textContent = 'n/a'; }
      }
      window.addEventListener('DOMContentLoaded', ()=>{ showBuild(); loadCurrent(); refreshLive(); setInterval(refreshLive, 2000); });
    </script>
  </head>
  <body>
    <header>
      <strong>VOLTTRON VEN Control</strong>
      <a href="/docs">API Docs</a>
      <a href="/config">Current Config</a>
      <span class="build">Build: <span id="build-id">(loading)</span></span>
    </header>
    <main>
      <div class="grid">
        <section class="card">
          <h2>Status</h2>
          <div class="row"><span id="led-enabled" class="led"></span><span class="muted">Agent Enabled</span></div>
          <div class="row"><span id="led-mqtt" class="led"></span><span class="muted">MQTT Connected</span></div>
          <div class="muted" id="status"></div>
        </section>
        <section class="card controls">
          <h2>Controls</h2>
          <div class="field"><label>Report Interval (s)</label><input id="interval" type="number" min="1" step="1" /></div>
          <div class="field"><label>Target Power (kW)</label><input id="target" type="number" step="0.1" /></div>
          <div class="field"><label>Enabled</label><input id="enabled" type="checkbox" /></div>
          <button onclick="applyChanges()">Apply</button>
        </section>
        <section class="card">
          <h2>Live</h2>
          <div>Power: <strong id="live-power">--</strong> kW</div>
          <div>Target: <strong id="live-target">--</strong> kW</div>
          <div>Interval: <strong id="live-interval">--</strong> s</div>
          <div>Event: <strong id="live-event">—</strong></div>
          <div>Last publish: <span id="live-last-publish">—</span></div>
        </section>
      </div>
      <div class="eventbar" id="eventbar"><span class="muted">No active event</span></div>
    </main>
  </body>
</html>
